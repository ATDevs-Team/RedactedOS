#/!bin/sh

echo "Running emulator"

ARGS=""
if [ "$1" = "debug" ]; then
  ARGS="-monitor unix:/tmp/qemu-monitor-socket,server,nowait -s -S"
fi

MSI_CAPABILITIES=""

XHCI_CAPABILITIES="$(qemu-system-aarch64 -device qemu-xhci,help)"

if echo "$XHCI_CAPABILITIES" | grep -q "msi "; then
  MSI_CAPABILITIES="msi=on,msix=off,"
fi

qemu-system-aarch64 \
-M raspi4b \
-kernel kernel.elf \
-display sdl \
-netdev vmnet-bridged,id=net0,ifname=en0 \
-serial mon:stdio \
-d guest_errors \
$ARGS
