#/!bin/sh

echo "Cleaning project"
make clean
echo "Building project"
make
echo "Running emulator"

ARGS=""
if [ "$1" = "debug" ]; then
  ARGS="-monitor unix:/tmp/qemu-monitor-socket,server,nowait -s -S"
fi

../qemu/build/qemu-system-aarch64-unsigned \
-M virt \
-cpu cortex-a72 \
-m 512M \
-kernel kernel.elf \
-device ramfb \
-display sdl \
-serial mon:stdio \
-drive file=disk.img,if=none,format=raw,id=hd0 \
-device virtio-blk-pci,drive=hd0 \
-device qemu-xhci,msi=on,msix=off,id=usb \
-device usb-kbd,bus=usb.0 \
$ARGS
